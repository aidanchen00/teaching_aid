# ğŸ•¸ï¸ Knowledge Graph System - Complete Explanation

## Overview

The knowledge graph is an **interactive 3D force-directed graph** that visualizes learning topics and their relationships. The AI voice agent controls it based on what you say, creating dynamic learning pathways.

---

## ğŸ¯ The 3 Initial Nodes

Every new session starts with **exactly 3 hardcoded nodes**:

```python
INITIAL_NODES = [
    GraphNode(id="threejs", label="Three.js", vizType="three"),
    GraphNode(id="manim", label="Manim", vizType="video"),
    GraphNode(id="nano-banana-pro", label="Nano Banana Pro", vizType="image"),
]
```

### Why These 3?
They represent the **3 types of visualizations** the system can show:
1. **Three.js** â†’ Interactive 3D scenes (`vizType="three"`)
2. **Manim** â†’ Animated math videos (`vizType="video"`)
3. **Nano Banana Pro** â†’ Static diagrams (`vizType="image"`)

These are **placeholder topics** to demonstrate the visualization types. They get **replaced** when you ask the AI to teach you something.

---

## ğŸ”„ How It Works: The Full Flow

### 1. **Session Creation**
```
User clicks START on curriculum
    â†“
POST /session/create
    â†“
Backend creates session with 3 initial nodes
    â†“
Returns sessionId
    â†“
Frontend joins LiveKit room: "learning-room-{sessionId}"
```

**Data Structure:**
```python
Session(
    session_id="abc-123",
    center_id="threejs",  # Default center node
    nodes=[ThreeJS, Manim, NanoBananaPro],
    links=[],  # No connections initially
    curriculum_context={...}  # From nexhacksv0
)
```

### 2. **Voice Interaction**
```
You say: "teach me calculus"
    â†“
LiveKit captures audio â†’ ElevenLabs STT â†’ Text transcript
    â†“
Agent receives: "teach me calculus"
    â†“
Agent's explore_topic() function tool activates
    â†“
Calls backend: POST /chat with "calculus"
```

### 3. **AI Graph Generation**
```
Backend /chat endpoint receives "calculus"
    â†“
Sends prompt to Gemini 2.0 Flash:
    "Generate a knowledge graph about: calculus"
    â†“
Gemini returns JSON:
{
  "message": "Calculus studies rates of change...",
  "nodes": [
    {"id": "calculus", "label": "Calculus", "vizType": "three"},
    {"id": "derivatives", "label": "Derivatives", "vizType": "three"},
    {"id": "integrals", "label": "Integrals", "vizType": "video"},
    {"id": "limits", "label": "Limits", "vizType": "image"}
  ],
  "links": [
    {"source": "calculus", "target": "derivatives"},
    {"source": "calculus", "target": "integrals"},
    {"source": "calculus", "target": "limits"}
  ],
  "centerId": "calculus"
}
    â†“
Backend saves to session (replaces 3 initial nodes)
    â†“
Returns graph data to agent
```

### 4. **Frontend Update**
```
Agent publishes LiveKit data message:
{
  "type": "command",
  "payload": {
    "action": "update_graph",
    "graph": {nodes, links, centerId},
    "sessionId": "abc-123"
  }
}
    â†“
Frontend receives message via useAgentDataChannel hook
    â†“
Updates KnowledgeGraphPanel component
    â†“
ForceGraph3D re-renders with new nodes
    â†“
You see: Calculus (center) with 3 connected topics
```

### 5. **Node Interaction**
```
You click "Derivatives" node
    â†“
Frontend calls: POST /session/{id}/select_node
    â†“
Backend updates center_id to "derivatives"
    â†“
Frontend switches to VIZ mode
    â†“
Shows Three.js visualization for Derivatives
```

OR via voice:
```
You say: "show me derivatives"
    â†“
Agent's select_topic() function activates
    â†“
Sends LiveKit command: "select_node_by_label"
    â†“
Frontend selects node and shows visualization
```

---

## ğŸ“Š Graph Structure Rules

### Nodes
- **Exactly 4 nodes** per graph:
  - 1 center node (main topic)
  - 3 branch nodes (subtopics)
- Each node has:
  - `id`: lowercase-with-hyphens
  - `label`: Human readable (e.g., "Derivatives")
  - `vizType`: "three" | "video" | "image"

### Links
- **Exactly 3 links** per graph
- Always: center â†’ branch
- No branch-to-branch connections
- No multi-level hierarchy

### Example Graph
```
        Calculus (center)
       /     |     \
Derivatives Integrals Limits
   (three)   (video)  (image)
```

---

## ğŸ¨ Visualization Types

Each node has a `vizType` that determines what happens when you click it:

### 1. **"three"** - Interactive 3D Scenes
- Built with Three.js + React Three Fiber
- Examples: geometric shapes, coordinate systems, neural networks
- User can rotate, zoom, interact

### 2. **"video"** - Animated Explanations
- Generated by Manim (math animation engine)
- Examples: step-by-step proofs, transformations, algorithms
- Plays automatically when node selected

### 3. **"image"** - Static Diagrams
- Educational images, formulas, flowcharts
- Examples: definitions, comparisons, reference diagrams
- Shows immediately when node selected

---

## ğŸ§  AI Agent's Tools

The voice agent has 3 function tools to control the graph:

### 1. `explore_topic(topic: str)`
**When:** User asks about a NEW topic not in current graph
**Examples:**
- "teach me calculus"
- "what is machine learning"
- "explain quantum physics"

**What it does:**
1. Calls `/chat` endpoint with topic
2. Gemini generates 4-node graph
3. Replaces entire current graph
4. Updates frontend via LiveKit

### 2. `select_topic(topic_label: str)`
**When:** User wants to see a topic ALREADY in the graph
**Examples:**
- "show me derivatives"
- "go to integrals"
- "I want to see limits"

**What it does:**
1. Finds node by label (case-insensitive)
2. Sends LiveKit command to frontend
3. Frontend switches to VIZ mode
4. Shows visualization for that node

### 3. `back_to_graph()`
**When:** User wants to return to graph view
**Examples:**
- "go back"
- "return to the graph"
- "show me the map"

**What it does:**
1. Sends LiveKit command to frontend
2. Frontend switches back to GRAPH mode
3. Shows full force-directed graph

---

## ğŸ—„ï¸ Data Storage

### Session Store (In-Memory)
```python
sessions: Dict[str, Session] = {
    "abc-123": Session(
        session_id="abc-123",
        center_id="calculus",
        nodes=[...],  # Current graph nodes
        links=[...],  # Current graph links
        curriculum_context={...}  # From nexhacksv0
    )
}
```

**Persistence:**
- âŒ In-memory only (lost on restart)
- âœ… Per-session (each room has its own graph)
- âœ… Survives across graph updates

**Future:** Could use PostgreSQL/Redis for persistence

---

## ğŸ­ Frontend Components

### Component Hierarchy
```
room/page.tsx
â”œâ”€â”€ VideoRoom (left panel)
â”‚   â””â”€â”€ LiveKit audio/video
â””â”€â”€ LearningPanel (right panel)
    â”œâ”€â”€ mode: 'GRAPH' | 'VIZ'
    â”œâ”€â”€ KnowledgeGraphPanel
    â”‚   â””â”€â”€ ForceGraph3D (3D visualization)
    â””â”€â”€ LessonOverlay
        â”œâ”€â”€ ThreeScene (vizType="three")
        â”œâ”€â”€ VideoLesson (vizType="video")
        â””â”€â”€ ImageLesson (vizType="image")
```

### State Management
```typescript
const [graph, setGraph] = useState<GraphData>({
  centerId: "threejs",
  nodes: [
    {id: "threejs", label: "Three.js", vizType: "three"},
    {id: "manim", label: "Manim", vizType: "video"},
    {id: "nano-banana-pro", label: "Nano Banana Pro", vizType: "image"}
  ],
  links: []
});
```

### Graph Updates
```typescript
// Agent sends LiveKit data message
useAgentDataChannel(room, (command) => {
  if (command.action === 'update_graph') {
    setGraph(command.payload.graph);
    setMode('GRAPH');
  }
});
```

---

## ğŸ”€ Update Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER VOICE INPUT                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    "teach me X"
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LIVEKIT VOICE AGENT (Backend)              â”‚
â”‚  - ElevenLabs STT (speech â†’ text)                       â”‚
â”‚  - Gemini 2.0 Flash (understands intent)                â”‚
â”‚  - Function tool: explore_topic()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  Calls /chat endpoint
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                CHAT API (Backend)                       â”‚
â”‚  - Receives topic query                                 â”‚
â”‚  - Sends prompt to Gemini 2.0 Flash                     â”‚
â”‚  - Gemini generates graph JSON                          â”‚
â”‚  - Validates structure                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  Returns graph data
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SESSION STORE (Backend)                    â”‚
â”‚  - update_session_from_chat()                           â”‚
â”‚  - Replaces nodes and links                             â”‚
â”‚  - Updates center_id                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  Graph saved
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LIVEKIT VOICE AGENT (Backend)              â”‚
â”‚  - Receives graph data                                  â”‚
â”‚  - Updates internal state                               â”‚
â”‚  - Publishes LiveKit data message                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
              LiveKit data channel
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FRONTEND (Next.js)                         â”‚
â”‚  - useAgentDataChannel receives message                 â”‚
â”‚  - Updates graph state                                  â”‚
â”‚  - KnowledgeGraphPanel re-renders                       â”‚
â”‚  - ForceGraph3D shows new nodes                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  USER SEES NEW GRAPH
```

---

## ğŸ’¡ Key Design Decisions

### Why 3 Initial Nodes?
- Demonstrates all 3 visualization types
- Provides starting point before AI generates content
- Shows users what the graph looks like

### Why 4 Nodes Per Graph?
- Simple enough to visualize clearly
- Complex enough to show relationships
- Prevents information overload
- Fast to generate with AI

### Why In-Memory Storage?
- Fast access during sessions
- No database setup needed
- Suitable for ephemeral learning sessions
- Can be upgraded to persistent DB later

### Why Voice Control?
- Hands-free learning (looking at visualizations)
- Natural conversational interface
- More engaging than typing
- Demonstrates LiveKit capabilities

---

## ğŸ”§ Customization Options

### Change Initial Nodes
Edit `backend/api/session_store.py`:
```python
INITIAL_NODES = [
    GraphNode(id="topic1", label="Your Topic 1", vizType="three"),
    GraphNode(id="topic2", label="Your Topic 2", vizType="video"),
    GraphNode(id="topic3", label="Your Topic 3", vizType="image"),
]
```

### Change Graph Size
Edit `backend/api/routes/chat.py` SYSTEM_PROMPT:
```python
# Instead of "EXACTLY 4 nodes"
"Generate 6 nodes: 1 center + 5 branches"
```

### Add Links Between Branches
Edit SYSTEM_PROMPT to allow additional link types:
```python
"Links: center to all branches, plus up to 2 cross-links between branches"
```

### Change Visualization Logic
Edit `frontend/components/lesson-overlay.tsx`:
- Add new vizType (e.g., "audio", "quiz")
- Custom rendering logic per type

---

## ğŸ“š API Reference

### Create Session
```http
POST /session/create
Content-Type: application/json

{
  "curriculum": {
    "title": "Intro to Calculus",
    "school": "MIT",
    "topics": ["Derivatives", "Integrals"]
  }
}

â†’ {"sessionId": "abc-123"}
```

### Get Graph
```http
GET /session/{sessionId}/graph

â†’ {
  "centerId": "threejs",
  "nodes": [...],
  "links": [...]
}
```

### Generate Graph
```http
POST /chat
Content-Type: application/json

{
  "message": "teach me calculus",
  "sessionId": "abc-123"
}

â†’ {
  "message": "Calculus studies...",
  "nodes": [...],
  "links": [...],
  "centerId": "calculus"
}
```

### Select Node
```http
POST /session/{sessionId}/select_node
Content-Type: application/json

{
  "nodeId": "derivatives"
}

â†’ {
  "centerId": "derivatives",
  "nodes": [...],
  "links": [...]
}
```

---

## ğŸ“ Current Status Summary

**Initial State:**
- 3 hardcoded nodes (Three.js, Manim, Nano Banana Pro)
- No links
- Center: "threejs"

**After "teach me calculus":**
- 4 AI-generated nodes (Calculus + 3 subtopics)
- 3 links (center â†’ branches)
- Center: "calculus"

**Interaction:**
- Voice: "show me derivatives" â†’ Switches to visualization
- Click node â†’ Shows visualization
- Voice: "go back" â†’ Returns to graph view

---

**Summary:** The knowledge graph is a **dynamic, AI-generated, voice-controlled visualization system** that adapts to what you want to learn. It starts with 3 demo nodes and transforms based on your voice commands, creating personalized learning pathways with interactive 3D, video, and image visualizations.
